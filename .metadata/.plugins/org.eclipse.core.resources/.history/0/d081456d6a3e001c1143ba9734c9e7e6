#include "comms_n64_console.h"
#include "stm32f4xx_hal.h"

// Initializer
void ExpansionPort_Init()
{
	// Set parameters for expansion port pins
	__HAL_RCC_GPIOA_CLK_ENABLE();
	__HAL_RCC_UART1_CLK_ENABLE();

	GPIO_InitTypeDef GPIO_InitStruct_ExpansionPort = {0};

	// UART4 TX - expansion port, channel 1
	GPIO_InitStruct_ExpansionPort.Pin = COMMS_TX_EXPANSION1_PIN_HAL;
	GPIO_InitStruct_ExpansionPort.Mode = GPIO_MODE_AF_PP;
	GPIO_InitStruct_ExpansionPort.Alternate = GPIO_AF8_UART4;
	GPIO_InitStruct_ExpansionPort.Pull = GPIO_NOPULL;
	GPIO_InitStruct_ExpansionPort.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
	HAL_GPIO_Init(COMMS_TX_EXPANSION1_PORT, &GPIO_InitStruct_ExpansionPort);

	// UART4 RX - expansion port, channel 1
	GPIO_InitStruct_ExpansionPort.Pin = COMMS_RX_EXPANSION1_PIN_HAL;
	GPIO_InitStruct_ExpansionPort.Mode = GPIO_MODE_AF_PP;
	GPIO_InitStruct_ExpansionPort.Alternate = GPIO_AF8_UART4;
	GPIO_InitStruct_ExpansionPort.Pull = GPIO_NOPULL;
	GPIO_InitStruct_ExpansionPort.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
	HAL_GPIO_Init(COMMS_RX_EXPANSION1_PORT, &GPIO_InitStruct_ExpansionPort);

	// Configure expansion, port channel 1 (uart4)
	huart1.Instance = UART4;
	huart1.Init.BaudRate = 19200;
	huart1.Init.WordLength = UART_WORDLENGTH_8B;
	huart1.Init.StopBits = UART_STOPBITS_1;
	huart1.Init.Parity = UART_PARITY_NONE;
	huart1.Init.Mode = UART_MODE_TX_RX;
	huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;
	huart1.Init.OverSampling = UART_OVERSAMPLING_16;

	HAL_UART_Init(&huart1);
}
//
//void ExpansionPort_SendData(ExpansionPortChannel_t expansionChannel, uint8_t tempData)
//{
//	// Setup arry to send data
//	uint8_t dataToSend[] = {tempData};
//
//	// Decide which channel to use
//	if(expansionChannel == CHANNEL_1)
//	{
//		// Always 1 byte to send with 1ms timeout
//		HAL_UART_Transmit(&huart1, dataToSend, OUTGOING_DATA_SIZE, COMMS_TIMEOUT_2MS);
//	}
//	else if(expansionChannel == CHANNEL_2)
//	{
//		//TODO: Setup other comm port
//	}
//	else
//	{
//		// unknown
//	}
//}
